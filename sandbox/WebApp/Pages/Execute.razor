@*add DFrame page*@
@page "/execute"

@inject ExecuteService ExecuteService
@inject ISummaryService SummaryService
<!--Hack: Generate Instance-->
@inject IWorkersService WorkerService
@inject IStatisticsService<AbStatistic> StatisticService

<SummaryComponent Summary="@summary"></SummaryComponent>

<h1>Execute</h1>

<ExecuteInputComponent HostAddress="@hostAddress" ExecuteData="@executeArgument" Status="@status" OnClickExecute="@OnClickExecute" OnClickStop="@OnClickStop"></ExecuteInputComponent>
<ExecuteOutputComponent ExecuteId="@context?.ExecuteId" HostAddress="@context?.HostAddress" Status="@context?.Status" Args="@context?.ExecuteArgument.Arguments"></ExecuteOutputComponent>

@code {
    private IExecuteContext context;
    private string hostAddress;
    private ExecuteData executeArgument;

    private string status => context?.Status;
    private Summary summary;

    protected override Task OnInitializedAsync()
    {
        context = ExecuteService.ExecuteContext;
        summary = SummaryService.Summary;
        InitProperty();
        return Task.CompletedTask;
    }

    private void InitProperty()
    {
        hostAddress = context?.HostAddress;
        executeArgument = context?.ExecuteArgument ?? new ExecuteData();
    }

    private async Task OnClickExecute(string hostAddress, ExecuteData executeData)
    {
        context = ExecuteService.CreateContext(hostAddress, executeData.ProcessCount, executeData.WorkerPerProcess, executeData.ExecutePerWorker, executeData.WorkerName);
        var exec = ExecuteService.ExecuteAsync();
        InitProperty();
        StateHasChanged();
        await exec;
        StateHasChanged();
    }
    private async Task OnClickStop()
    {
        await ExecuteService.StopAsync();
        StateHasChanged();
    }
}
